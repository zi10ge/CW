---
- hosts: localhost
  connection: local
    
  tasks:     
    - name: Wait for SSH to come up
      wait_for:
        host: "{{ item }}"
        port: 22
        delay: 30
        timeout: 320
        sleep: 30
        state: started
      with_inventory_hostnames:
        - all
    
- name: Build instance
  hosts: build
  remote_user: ubuntu
  become: yes
  become_user: root
      
  vars:
    ansible_ssh_private_key_file: "./key4CW.pem"
    
  tasks:
    
    - name: Install packages
      apt: pkg={{ item }} state=latest
      with_items:
        - default-jdk
        - maven
        - git
        - docker.io
    
    - name: clone boxfuse
      git: repo=https://github.com/boxfuse/boxfuse-sample-java-war-hello.git dest=/tmp/boxfuse
      tags: deploy
       
    - name: package boxfuse war
      command: mvn package -f /tmp/boxfuse

    - name: Add ubuntu to docker group
      command: sudo usermod -aG docker ubuntu

    - name: Copy dockerfile to build instance
      copy:
        src: ./Dockerfile
        dest: /tmp/boxfuse/target
    
    - name: Build docker image
      command: docker build -f /tmp/boxfuse/target/Dockerfile -t webapp /tmp/boxfuse

    - name: Tag docker image
      command: docker tag webapp:latest zi10ge/appcw:latest
     
    - name: Login on dockerhub
      command: 'docker login -u {{ foo2 }} -p {{ foo1 }}'

    - name: Push dockerimage to github
      command: 'docker push zi10ge/appcw:latest'

- name: Stage instance
  hosts: stage
  remote_user: ubuntu
  become: yes
  become_user: root
      
  vars:
    ansible_ssh_private_key_file: "./key4CW.pem"
    
  tasks:
    
    - name: Install packages
      apt: pkg={{ item }} state=latest
      with_items:
        - docker.io
    
    - name: Run docker image
      command: docker run -d -p 8080:8080 zi10ge/appcw:latest